<div class="tab-pane">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/order.css') }}">

    <div class="order-detail">
        <h2>Order: {{ order_id }}</h2>
        <div id="order-info"></div>

        <h3>Lines</h3>
        <div style="display:flex; gap:6px; margin-bottom:8px;">
            <button onclick="exportAll(false)" style="padding:3px 10px;border:1px solid #000;background:#fff;cursor:pointer;font-size:10px;">AI E All</button>
            <button onclick="exportAll(true)" style="padding:3px 10px;border:1px solid #000;background:#fff;cursor:pointer;font-size:10px;">AI O All</button>
        </div>
        <table id="lines-table">
            <thead>
                <tr>
                    <th>Layout</th>
                    <th>Type</th>
                    <th>Qty</th>
                    <th>Variables</th>
                    <th>Export</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="layout-preview-modal" class="preview-modal-overlay" onclick="closePreview(event)">
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <span id="preview-modal-title"></span>
                <button class="preview-modal-close" onclick="closePreview()">&times;</button>
            </div>
            <div id="preview-body" class="preview-modal-body"></div>
        </div>
    </div>

    <script>
    var orderLines = [];

    (function() {
        fetch('/order/api/{{ order_id }}')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var order = data.order;
                orderLines = data.lines;

                document.getElementById('order-info').innerHTML =
                    '<div class="info-grid">' +
                    '<div class="info-row"><label>Customer:</label><span>' + order.company_name + '</span></div>' +
                    '<div class="info-row"><label>PO #:</label><span>' + order.po_number + '</span></div>' +
                    '<div class="info-row"><label>Status:</label><span>' + order.status + '</span></div>' +
                    '<div class="info-row"><label>Created:</label><span>' + order.created_at + '</span></div>' +
                    '</div>';

                var tbody = document.querySelector('#lines-table tbody');
                orderLines.forEach(function(l, idx) {
                    var vars = l.variable_values ? JSON.parse(l.variable_values) : {};
                    var varParts = [];
                    for (var k in vars) { varParts.push('#' + (parseInt(k) + 1) + ': ' + vars[k]); }
                    var varDisplay = varParts.length ? varParts.join(', ') : 'â€”';

                    var tr = document.createElement('tr');
                    tr.innerHTML =
                        '<td><a href="#" class="layout-link" onclick="previewLayout(' + l.layout_id + ', \'' + l.layout_type + '\', \'' + l.layout_name.replace(/'/g, "\\'") + '\'); return false;">' + l.layout_name + '</a></td>' +
                        '<td>' + l.layout_type + '</td>' +
                        '<td>' + l.quantity + '</td>' +
                        '<td>' + varDisplay + '</td>' +
                        '<td class="export-cell">' +
                            '<button onclick="exportLine(' + idx + ', false)">AI E</button>' +
                            '<button onclick="exportLine(' + idx + ', true)">AI O</button>' +
                        '</td>';
                    tbody.appendChild(tr);
                });
            });
    })();

    function previewLayout(layoutId, layoutType, layoutName) {
        var route = layoutType === 'json' ? '/layout/create/json' : '/layout/create/pdf';
        var content = document.querySelector('.preview-modal-content');
        content.style.left = '';
        content.style.top = '';
        document.getElementById('preview-modal-title').textContent = layoutName;
        var body = document.getElementById('preview-body');
        body.innerHTML = '<div style="padding:40px;text-align:center;font-size:11px;">Loading...</div>';
        document.getElementById('layout-preview-modal').classList.add('active');

        fetch(route + '?load=' + layoutId)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var src = doc.querySelector('.tab-pane') || doc.body;

                // Create a tab-pane wrapper with data-tab-instance so the editor init finds it
                body.innerHTML = '';
                var pane = document.createElement('div');
                pane.className = 'tab-pane active';
                pane.setAttribute('data-tab-instance', 'preview-' + Date.now());
                if (src.hasAttribute('data-layout-id')) {
                    pane.setAttribute('data-layout-id', src.getAttribute('data-layout-id'));
                } else {
                    pane.setAttribute('data-layout-id', layoutId);
                }
                pane.innerHTML = src.innerHTML;
                body.appendChild(pane);

                // Execute scripts in order
                var scripts = pane.querySelectorAll('script');
                scripts.forEach(function(script) {
                    var newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
            });
    }

    function closePreview(e) {
        if (e && e.target !== e.currentTarget) return;
        var modal = document.getElementById('layout-preview-modal');
        modal.classList.remove('active');
        document.getElementById('preview-body').innerHTML = '';
    }

    // Draggable modal
    (function() {
        var header = null;
        var content = null;
        var dragging = false;
        var offsetX = 0, offsetY = 0;

        document.addEventListener('mousedown', function(e) {
            header = document.querySelector('.preview-modal-header');
            content = document.querySelector('.preview-modal-content');
            if (!header || !header.contains(e.target) || e.target.tagName === 'BUTTON') return;
            dragging = true;
            var rect = content.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            header.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!dragging) return;
            content.style.left = (e.clientX - offsetX) + 'px';
            content.style.top = (e.clientY - offsetY) + 'px';
        });

        document.addEventListener('mouseup', function() {
            if (!dragging) return;
            dragging = false;
            if (header) header.style.cursor = '';
        });
    })();

    function exportLine(lineIdx, outlined) {
        var line = orderLines[lineIdx];
        if (!line || !line.generated_data) {
            alert('No generated data for this line.');
            return;
        }

        var genData = typeof line.generated_data === 'string' ? JSON.parse(line.generated_data) : line.generated_data;

        var payload;
        if (genData.exportPayload) {
            // Use pre-built export payload (includes flattened document tree + overlays)
            payload = genData.exportPayload;
            payload.outlined = !!outlined;
            payload.separateInvisible = true;
        } else {
            // Fallback for older orders without exportPayload
            var comps = genData.components || [];
            payload = {
                label: { width: genData.pdfWidth || genData.label_width || 0, height: genData.pdfHeight || genData.label_height || 0 },
                components: comps.map(function(c) {
                    return {
                        type: c.type,
                        x: c.x,
                        y: c.y,
                        width: c.w || c.width || 0,
                        height: c.h || c.height || 0,
                        content: c.content,
                        fontFamily: c.fontFamily,
                        fontId: c.fontId || null,
                        fontSize: c.fontSize,
                        bold: c.bold || false,
                        italic: c.italic || false,
                        color: c.color || '#000000',
                        letterSpacing: c.letterSpacing || 0,
                        alignH: c.alignH || 'left',
                        alignV: c.alignV || 'top',
                        pathData: c.pathData,
                        visible: c.visible,
                        imageUrl: c.imageUrl,
                        imageFit: c.imageFit,
                        qrData: c.qrData,
                        barcodeData: c.barcodeData,
                        barcodeFormat: c.barcodeFormat,
                        rotation: c.rotation || 0,
                        boundsRectIdx: c.boundsRectIdx != null ? c.boundsRectIdx : -1,
                        page: 0
                    };
                }),
                boundsRects: [],
                outlined: !!outlined,
                separateInvisible: true
            };
        }

        fetch('/export/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Export failed');
            return response.blob();
        })
        .then(function(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = line.layout_name + (outlined ? '_outlined' : '_editable') + '.ai';
            a.click();
            URL.revokeObjectURL(url);
        })
        .catch(function(err) {
            alert('Export failed: ' + err.message);
        });
    }

    function exportAll(outlined) {
        var pages = [];
        for (var i = 0; i < orderLines.length; i++) {
            var line = orderLines[i];
            if (!line || !line.generated_data) continue;
            var genData = typeof line.generated_data === 'string'
                ? JSON.parse(line.generated_data) : line.generated_data;
            if (genData.exportPayload) {
                pages.push(genData.exportPayload);
            }
        }
        if (pages.length === 0) {
            alert('No generated data to export.');
            return;
        }
        fetch('/export/ai/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ outlined: !!outlined, pages: pages })
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Batch export failed');
            return response.blob();
        })
        .then(function(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'order_{{ order_id }}' + (outlined ? '_outlined' : '_editable') + '.ai';
            a.click();
            URL.revokeObjectURL(url);
        })
        .catch(function(err) {
            alert('Batch export failed: ' + err.message);
        });
    }
    </script>
</div>
