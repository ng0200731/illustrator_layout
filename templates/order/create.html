<div class="tab-pane">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/order.css') }}">

    <div class="order-create">
        <h2>Create Order</h2>

        <div class="form-section">
            <div class="form-row">
                <label>Customer</label>
                <select id="order-customer" onchange="onCustomerChange()">
                    <option value="">-- Select customer --</option>
                </select>
            </div>
        </div>

        <div id="order-lines"></div>

        <div id="excel-section" class="form-section" style="display:none;">
            <h3>Excel Import</h3>
            <div class="excel-actions">
                <button onclick="downloadTemplate()" class="btn-excel">Download Template</button>
                <button onclick="downloadDummy()" class="btn-excel">Download Dummy</button>
            </div>
            <div class="excel-upload-area" id="excel-upload-area">
                <p>Drop .xlsx file here to import order lines</p>
                <p>or</p>
                <button onclick="document.getElementById('excel-input').click()" class="btn-excel">Choose File</button>
            </div>
            <input type="file" id="excel-input" accept=".xlsx" style="display:none;" onchange="handleExcelUpload(this)">
            <div id="excel-error" class="error" style="display:none;"></div>
            <div id="excel-success" class="success" style="display:none;"></div>
        </div>

        <div class="form-section" id="layout-section" style="display:none;">
            <h3>Select Layout</h3>
            <table class="layout-search-table" id="layout-table">
                <thead>
                    <tr>
                        <th><input type="text" id="filter-name" placeholder="Search name..." oninput="filterLayouts()"></th>
                        <th>Created</th>
                        <th># Vars</th>
                    </tr>
                </thead>
                <tbody id="layout-tbody"></tbody>
            </table>
            <div id="no-layouts-msg" class="no-vars" style="display:none;">No layouts found</div>
        </div>

        <div class="form-actions" id="submit-section" style="display:none;">
            <button onclick="showPoModal()" class="btn-primary">Create Order</button>
        </div>
        <div id="order-result"></div>
    </div>

    <!-- PO# Modal -->
    <div id="po-modal" class="preview-modal-overlay" onclick="closePoModal(event)">
        <div class="po-modal-content">
            <div class="preview-modal-header">
                <span>Order Details</span>
                <button class="preview-modal-close" onclick="closePoModal()">&times;</button>
            </div>
            <div class="po-modal-body">
                <div class="form-row">
                    <label>PO #</label>
                    <input type="text" id="po-input" placeholder="Purchase order number">
                    <button onclick="autoGeneratePo()" class="btn-auto-po">Auto</button>
                </div>
                <div class="form-actions" style="margin-top:12px;">
                    <button onclick="confirmOrder()" class="btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    var availableLayouts = [];
    var orderLinesList = []; // [{layout_id, layoutName, variableValues:{}}]
    var currentCustomerId = '';
    var currentCustomerName = '';
    var currentLayoutVars = [];
    var currentLayoutName = '';
    (function init() {
        fetch('/customer/list')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var customers = data.customers || [];
                var sel = document.getElementById('order-customer');
                customers.forEach(function(c) {
                    var opt = document.createElement('option');
                    opt.value = c.customer_id;
                    opt.textContent = c.company_name;
                    opt.dataset.name = c.company_name;
                    sel.appendChild(opt);
                });
            });
    })();

    function onCustomerChange() {
        var sel = document.getElementById('order-customer');
        currentCustomerId = sel.value;
        currentCustomerName = sel.selectedIndex > 0 ? sel.options[sel.selectedIndex].dataset.name : '';
        availableLayouts = [];
        orderLinesList = [];
        document.getElementById('order-lines').innerHTML = '';
        document.getElementById('filter-name').value = '';
        hideSection('layout-section');
        hideSection('submit-section');
        hideSection('excel-section');
        currentLayoutVars = [];
        currentLayoutName = '';
        document.getElementById('order-result').innerHTML = '';
        if (!currentCustomerId) return;

        fetch('/order/api/layouts/' + currentCustomerId)
            .then(function(r) { return r.json(); })
            .then(function(layouts) {
                availableLayouts = layouts;
                showSection('layout-section');
                if (layouts.length === 0) {
                    document.getElementById('no-layouts-msg').style.display = '';
                    document.getElementById('layout-table').style.display = 'none';
                } else {
                    document.getElementById('no-layouts-msg').style.display = 'none';
                    document.getElementById('layout-table').style.display = '';
                    renderLayoutTable(layouts);
                }
            });
    }
    function renderLayoutTable(layouts) {
        var tbody = document.getElementById('layout-tbody');
        tbody.innerHTML = '';
        layouts.forEach(function(l) {
            var tr = document.createElement('tr');
            tr.className = 'layout-row';
            tr.dataset.layoutId = l.id;
            tr.onclick = function() { selectLayout(l.id); };
            var created = l.created_at ? l.created_at.substring(0, 10) : '-';
            tr.innerHTML =
                '<td>' + escHtml(l.name) + '</td>' +
                '<td>' + created + '</td>' +
                '<td>' + (l.var_count || 0) + '</td>';
            tbody.appendChild(tr);
        });
    }

    function filterLayouts() {
        var q = document.getElementById('filter-name').value.toLowerCase();
        var filtered = availableLayouts.filter(function(l) {
            return l.name.toLowerCase().indexOf(q) !== -1;
        });
        renderLayoutTable(filtered);
    }

    function selectLayout(layoutId) {
        var layout = null;
        for (var i = 0; i < availableLayouts.length; i++) {
            if (availableLayouts[i].id === layoutId) { layout = availableLayouts[i]; break; }
        }
        if (!layout) return;

        // Parse layout data for variables
        var data = layout.data ? (typeof layout.data === 'string' ? JSON.parse(layout.data) : layout.data) : {};
        var comps = data.components || [];
        var vars = [];
        comps.forEach(function(c, ci) {
            if (!c.isVariable) return;
            vars.push({ idx: ci, content: c.content || '', fontFamily: c.fontFamily || '', fontSize: c.fontSize || 12 });
        });

        // Add to orderLinesList
        var lineObj = { layout_id: layoutId, layoutName: layout.name, vars: vars, variableValues: {} };
        // Pre-fill variable values with original content
        vars.forEach(function(v) { lineObj.variableValues[v.idx] = v.content; });
        orderLinesList.push(lineObj);

        currentLayoutVars = vars;
        currentLayoutName = layout.name;

        // Collapse layout table, render line cards
        hideSection('layout-section');
        renderOrderLines();
        showSection('submit-section');
        if (vars.length > 0) {
            showSection('excel-section');
            document.getElementById('excel-error').style.display = 'none';
            document.getElementById('excel-success').style.display = 'none';
        }
    }
    function renderOrderLines() {
        var container = document.getElementById('order-lines');
        container.innerHTML = '';
        orderLinesList.forEach(function(line, li) {
            var card = document.createElement('div');
            card.className = 'order-line-card';

            var header = '<div class="line-card-header">' +
                '<span>' + escHtml(line.layoutName) + '</span>' +
                '<button class="btn-remove" onclick="removeLine(' + li + ')">âœ•</button>' +
                '</div>';

            var varsHtml = '';
            if (line.vars.length === 0) {
                varsHtml = '<span class="no-vars">No variable fields</span>';
            } else {
                line.vars.forEach(function(v) {
                    varsHtml +=
                        '<div class="var-row-side">' +
                            '<div class="var-left">' + escHtml(v.content) + '</div>' +
                            '<textarea class="var-right" data-line="' + li + '" data-idx="' + v.idx + '" ' +
                                'placeholder="Enter value" rows="2" oninput="onVarInput(this)">' +
                                escHtml(line.variableValues[v.idx] || '') +
                            '</textarea>' +
                        '</div>';
                });
            }

            card.innerHTML = header + '<div class="line-card-vars">' + varsHtml + '</div>';
            container.appendChild(card);
        });

        // Add "+" button to duplicate same layout with new variable set
        var addBtn = document.createElement('button');
        addBtn.className = 'btn-add-layout';
        addBtn.textContent = '+ Add Set';
        addBtn.onclick = addVariableSet;
        container.appendChild(addBtn);
    }

    function addVariableSet() {
        if (orderLinesList.length === 0) return;
        var src = orderLinesList[0];
        var lineObj = { layout_id: src.layout_id, layoutName: src.layoutName, vars: src.vars, variableValues: {} };
        src.vars.forEach(function(v) { lineObj.variableValues[v.idx] = v.content; });
        orderLinesList.push(lineObj);
        renderOrderLines();
    }

    function onVarInput(el) {
        var li = parseInt(el.dataset.line);
        var idx = el.dataset.idx;
        orderLinesList[li].variableValues[idx] = el.value;
    }

    function addAnotherLayout() {
        document.getElementById('filter-name').value = '';
        renderLayoutTable(availableLayouts);
        showSection('layout-section');
    }

    function removeLine(li) {
        orderLinesList.splice(li, 1);
        renderOrderLines();
        if (orderLinesList.length === 0) {
            hideSection('submit-section');
            hideSection('excel-section');
            addAnotherLayout();
        }
    }
    function showPoModal() {
        if (orderLinesList.length === 0) { alert('Add at least one layout.'); return; }
        document.getElementById('po-input').value = '';
        document.getElementById('po-modal').classList.add('active');
    }

    function closePoModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('po-modal').classList.remove('active');
    }

    function autoGeneratePo() {
        var now = new Date();
        var pad = function(n) { return String(n).padStart(2, '0'); };
        var ts = now.getFullYear() + '-' + pad(now.getMonth() + 1) + '-' + pad(now.getDate()) +
            '_' + pad(now.getHours()) + '_' + pad(now.getMinutes()) + '_' + pad(now.getSeconds());
        var layoutName = orderLinesList.length > 0 ? orderLinesList[0].layoutName : '';
        var po = ts + '_' + currentCustomerName + '_' + layoutName;
        document.getElementById('po-input').value = po;
    }

    function confirmOrder() {
        var poNumber = document.getElementById('po-input').value.trim();
        if (!poNumber) { alert('Enter a PO number or click Auto.'); return; }

        var lines = orderLinesList.map(function(line) {
            var vv = {};
            var hasVals = false;
            for (var k in line.variableValues) {
                if (line.variableValues[k]) { vv[k] = line.variableValues[k]; hasVals = true; }
            }
            return {
                layout_id: line.layout_id,
                quantity: 1,
                variable_values: hasVals ? vv : null
            };
        });

        fetch('/order/api/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer_id: currentCustomerId, po_number: poNumber, lines: lines })
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(res) {
            closePoModal();
            if (res.ok) {
                openTab('Orders', '/order/view');
            } else {
                document.getElementById('order-result').innerHTML = '<p class="error">' + res.data.error + '</p>';
            }
        });
    }

    function viewOrder(orderId) {
        openTab('Order (' + orderId + ')', '/order/detail/' + orderId);
    }

    function createNewOrder() {
        document.getElementById('order-customer').value = '';
        document.getElementById('order-result').innerHTML = '';
        orderLinesList = [];
        availableLayouts = [];
        onCustomerChange();
    }

    function showSection(id) { document.getElementById(id).style.display = ''; }
    function hideSection(id) { document.getElementById(id).style.display = 'none'; }
    function escHtml(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function downloadTemplate() {
        if (currentLayoutVars.length === 0) return;
        fetch('/order/api/excel/template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                variables: currentLayoutVars.map(function(v) { return { idx: v.idx, content: v.content }; }),
                layout_name: currentLayoutName
            })
        })
        .then(function(r) {
            if (!r.ok) throw new Error('Download failed');
            return r.blob();
        })
        .then(function(blob) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentLayoutName + '_template.xlsx';
            a.click();
            URL.revokeObjectURL(a.href);
        })
        .catch(function(err) { alert(err.message); });
    }

    function downloadDummy() {
        if (currentLayoutVars.length === 0) return;
        fetch('/order/api/excel/dummy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                variables: currentLayoutVars.map(function(v) { return { idx: v.idx, content: v.content }; }),
                layout_name: currentLayoutName
            })
        })
        .then(function(r) {
            if (!r.ok) throw new Error('Download failed');
            return r.blob();
        })
        .then(function(blob) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentLayoutName + '_dummy.xlsx';
            a.click();
            URL.revokeObjectURL(a.href);
        })
        .catch(function(err) { alert(err.message); });
    }

    function handleExcelUpload(input) {
        var file = input.files[0];
        if (!file) return;

        var errDiv = document.getElementById('excel-error');
        var successDiv = document.getElementById('excel-success');
        errDiv.style.display = 'none';
        successDiv.style.display = 'none';

        var formData = new FormData();
        formData.append('file', file);
        formData.append('variables', JSON.stringify(
            currentLayoutVars.map(function(v) { return { idx: v.idx, content: v.content }; })
        ));

        fetch('/order/api/excel/upload', {
            method: 'POST',
            body: formData
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var src = orderLinesList[0];
                orderLinesList = [];
                data.rows.forEach(function(vv) {
                    orderLinesList.push({
                        layout_id: src.layout_id,
                        layoutName: src.layoutName,
                        vars: src.vars,
                        variableValues: vv
                    });
                });
                renderOrderLines();
                showSection('submit-section');
                successDiv.textContent = data.rows.length + ' order lines imported';
                successDiv.style.display = '';
            } else {
                errDiv.textContent = data.error;
                errDiv.style.display = '';
            }
        })
        .catch(function(err) {
            errDiv.textContent = 'Upload failed: ' + err.message;
            errDiv.style.display = '';
        });

        input.value = '';
    }

    (function initExcelDragDrop() {
        setTimeout(function() {
            var area = document.getElementById('excel-upload-area');
            if (!area) return;
            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
            });
            area.addEventListener('drop', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    var input = document.getElementById('excel-input');
                    var dt = new DataTransfer();
                    dt.items.add(e.dataTransfer.files[0]);
                    input.files = dt.files;
                    handleExcelUpload(input);
                }
            });
        }, 200);
    })();
    </script>
</div>
