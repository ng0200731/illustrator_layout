<div class="tab-pane">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/order.css') }}">

    <div class="order-create">
        <h2>Create Order</h2>

        <div class="form-section">
            <div class="form-row">
                <label>Customer</label>
                <select id="order-customer" onchange="onCustomerChange()">
                    <option value="">-- Select customer --</option>
                </select>
            </div>
        </div>

        <div class="form-section" id="layout-section" style="display:none;">
            <h3>Select Layout</h3>
            <table class="layout-search-table" id="layout-table">
                <thead>
                    <tr>
                        <th><input type="text" id="filter-name" placeholder="Search name..." oninput="filterLayouts()"></th>
                        <th>Created</th>
                        <th># Vars</th>
                    </tr>
                </thead>
                <tbody id="layout-tbody"></tbody>
            </table>
            <div id="no-layouts-msg" class="no-vars" style="display:none;">No layouts found for this customer</div>
        </div>

        <div class="form-section" id="selected-layout-section" style="display:none;">
            <h3>Selected Layout: <span id="selected-layout-name"></span></h3>
            <div id="line-variables"></div>
        </div>

        <div class="form-section" id="po-section" style="display:none;">
            <div class="form-row">
                <label>PO #</label>
                <input type="text" id="order-po" placeholder="Purchase order number">
            </div>
            <div class="form-row">
                <label>Quantity</label>
                <input type="number" id="order-qty" value="1" min="1" placeholder="Qty">
            </div>
        </div>

        <div class="form-actions" id="submit-section" style="display:none;">
            <button onclick="submitOrder()" class="btn-primary">Create Order</button>
        </div>
        <div id="order-result"></div>
    </div>

    <script>
    var availableLayouts = [];
    var selectedLayoutId = null;

    (function init() {
        fetch('/customer/list')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var customers = data.customers || [];
                var sel = document.getElementById('order-customer');
                customers.forEach(function(c) {
                    var opt = document.createElement('option');
                    opt.value = c.customer_id;
                    opt.textContent = c.company_name;
                    sel.appendChild(opt);
                });
            });
    })();
    function onCustomerChange() {
        var customerId = document.getElementById('order-customer').value;
        availableLayouts = [];
        selectedLayoutId = null;
        document.getElementById('layout-tbody').innerHTML = '';
        document.getElementById('filter-name').value = '';
        document.getElementById('line-variables').innerHTML = '';
        hideSection('layout-section');
        hideSection('selected-layout-section');
        hideSection('po-section');
        hideSection('submit-section');
        document.getElementById('order-result').innerHTML = '';
        if (!customerId) return;

        fetch('/order/api/layouts/' + customerId)
            .then(function(r) { return r.json(); })
            .then(function(layouts) {
                availableLayouts = layouts;
                showSection('layout-section');
                if (layouts.length === 0) {
                    document.getElementById('no-layouts-msg').style.display = '';
                    document.getElementById('layout-table').style.display = 'none';
                } else {
                    document.getElementById('no-layouts-msg').style.display = 'none';
                    document.getElementById('layout-table').style.display = '';
                    renderLayoutTable(layouts);
                }
            });
    }
    function renderLayoutTable(layouts) {
        var tbody = document.getElementById('layout-tbody');
        tbody.innerHTML = '';
        layouts.forEach(function(l) {
            var tr = document.createElement('tr');
            tr.className = 'layout-row' + (l.id === selectedLayoutId ? ' selected' : '');
            tr.dataset.layoutId = l.id;
            tr.onclick = function() { selectLayout(l.id); };
            var created = l.created_at ? l.created_at.substring(0, 10) : '-';
            tr.innerHTML =
                '<td>' + escHtml(l.name) + '</td>' +
                '<td>' + created + '</td>' +
                '<td>' + (l.var_count || 0) + '</td>';
            tbody.appendChild(tr);
        });
    }

    function filterLayouts() {
        var q = document.getElementById('filter-name').value.toLowerCase();
        var filtered = availableLayouts.filter(function(l) {
            return l.name.toLowerCase().indexOf(q) !== -1;
        });
        renderLayoutTable(filtered);
    }
    function selectLayout(layoutId) {
        selectedLayoutId = layoutId;
        var layout = null;
        for (var i = 0; i < availableLayouts.length; i++) {
            if (availableLayouts[i].id === layoutId) { layout = availableLayouts[i]; break; }
        }
        if (!layout) return;

        // highlight row
        var rows = document.querySelectorAll('.layout-row');
        rows.forEach(function(r) { r.classList.remove('selected'); });
        var sel = document.querySelector('.layout-row[data-layout-id="' + layoutId + '"]');
        if (sel) sel.classList.add('selected');

        document.getElementById('selected-layout-name').textContent = layout.name;
        showSection('selected-layout-section');
        showSection('po-section');
        showSection('submit-section');

        // render variable inputs
        var varsContainer = document.getElementById('line-variables');
        varsContainer.innerHTML = '';
        if (!layout.data) return;

        var data = typeof layout.data === 'string' ? JSON.parse(layout.data) : layout.data;
        var comps = data.components || [];
        var hasVars = false;

        comps.forEach(function(c, ci) {
            if (!c.isVariable) return;
            hasVars = true;
            var row = document.createElement('div');
            row.className = 'var-row';
            var lbl = document.createElement('label');
            var displayLabel = c.content || c.type || 'Variable';
            if (displayLabel.length > 40) displayLabel = displayLabel.substring(0, 40) + '...';
            lbl.textContent = displayLabel;
            lbl.title = c.content || '';
            var ta = document.createElement('textarea');
            ta.dataset.compIdx = ci;
            ta.placeholder = 'Enter value';
            ta.value = c.content || '';
            ta.rows = 3;
            row.appendChild(lbl);
            row.appendChild(ta);
            varsContainer.appendChild(row);
        });

        if (!hasVars) {
            varsContainer.innerHTML = '<span class="no-vars">No variable fields</span>';
        }
    }
    function submitOrder() {
        var customerId = document.getElementById('order-customer').value;
        var poNumber = document.getElementById('order-po').value.trim();
        if (!customerId || !poNumber) { alert('Select a customer and enter a PO number.'); return; }
        if (!selectedLayoutId) { alert('Select a layout.'); return; }

        var qty = parseInt(document.getElementById('order-qty').value, 10) || 1;
        var varInputs = document.querySelectorAll('#line-variables .var-row textarea');
        var variableValues = {};
        var hasVals = false;
        varInputs.forEach(function(inp) {
            if (inp.value) {
                variableValues[inp.dataset.compIdx] = inp.value;
                hasVals = true;
            }
        });

        var lines = [{
            layout_id: selectedLayoutId,
            quantity: qty,
            variable_values: hasVals ? variableValues : null
        }];

        fetch('/order/api/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer_id: customerId, po_number: poNumber, lines: lines })
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(res) {
            var el = document.getElementById('order-result');
            if (res.ok) {
                var oid = res.data.order_id;
                el.innerHTML =
                    '<div class="order-success">' +
                        '<p>Order <strong>' + oid + '</strong> created.</p>' +
                        '<div class="order-success-actions">' +
                            '<button onclick="viewOrder(\'' + oid + '\')">View Order</button>' +
                            '<button onclick="createNewOrder()">Create New Order</button>' +
                        '</div>' +
                    '</div>';
            } else {
                el.innerHTML = '<p class="error">' + res.data.error + '</p>';
            }
        });
    }

    function viewOrder(orderId) {
        openTab('Order (' + orderId + ')', '/order/detail/' + orderId);
    }

    function createNewOrder() {
        document.getElementById('order-customer').value = '';
        document.getElementById('order-po').value = '';
        document.getElementById('order-qty').value = '1';
        document.getElementById('order-result').innerHTML = '';
        selectedLayoutId = null;
        availableLayouts = [];
        onCustomerChange();
    }

    function showSection(id) { document.getElementById(id).style.display = ''; }
    function hideSection(id) { document.getElementById(id).style.display = 'none'; }
    function escHtml(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }
    </script>
</div>
